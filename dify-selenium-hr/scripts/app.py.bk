from flask import Flask, request, jsonify
import random, logging, time, os
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

app = Flask(__name__)

# === Logging è¨­å®š ===
logging.basicConfig(
    filename='/app/eip_checkin.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def eip_checkin(username, password):
    # === éš¨æ©Ÿæ‰“å¡æ™‚é–“ (08:40~08:55) ===
    hour = 8
    minute = random.randint(40, 55)
    time_str = f"{hour:02d}:{minute:02d}"
    full_time_str = f"{datetime.now().year}-{datetime.now().month:02d}-{datetime.now().day:02d}-{hour:02d}-{minute:02d}-00"
    logging.info(f"ğŸ’¡ ä»Šæ—¥æ‰“å¡æ™‚é–“ï¼š{time_str}")

    # === Chrome é¸é … ===
    chrome_options = Options()
    chrome_options.add_argument("--headless=new")  # è‹¥è¦é™¤éŒ¯å¯è¨»è§£æ­¤è¡Œ
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--window-size=1366,768")

    driver = webdriver.Chrome(service=Service("/usr/bin/chromedriver"), options=chrome_options)
    wait = WebDriverWait(driver, 15)

    try:
        # === é–‹å•Ÿç™»å…¥é  ===
        driver.get("https://eip.palsys.com.tw/UOF/Login.aspx?ReturnUrl=%2fUOF%2fWKF%2fFormUse%2fPersonalBox%2fApplyFormList.aspx%3ffillFormDirectly%3dtrue%26formId%3dClockIn&fillFormDirectly=true&formId=ClockIn")

        # === ç™»å…¥ ===
        wait.until(EC.element_to_be_clickable((By.ID, "txtAccount"))).send_keys(username)
        wait.until(EC.element_to_be_clickable((By.ID, "txtPwd"))).send_keys(password)
        wait.until(EC.element_to_be_clickable((By.ID, "btnSubmit"))).click()
        time.sleep(5)

        # === åˆ‡æ› Frame ===
        driver.switch_to.frame(0)
        driver.switch_to.frame(0)

        # === å¡«å¯«æ‰“å¡æ™‚é–“æ¬„ä½ ===
        # dateInput
        date_input = wait.until(EC.presence_of_element_located((By.ID,
            "ctl00_ContentPlaceHolder1_VersionFieldCollectionUsingUC1_versionFieldUC4_RadTimePicker1_dateInput")))
        driver.execute_script("arguments[0].scrollIntoView(true);", date_input)
        wait.until(EC.element_to_be_clickable((By.ID,
            "ctl00_ContentPlaceHolder1_VersionFieldCollectionUsingUC1_versionFieldUC4_RadTimePicker1_dateInput")))
        date_input.clear()
        date_input.send_keys(time_str)

        # RadTimePicker ä¸»æ¬„ä½
        time_input = wait.until(EC.presence_of_element_located((By.ID,
            "ctl00_ContentPlaceHolder1_VersionFieldCollectionUsingUC1_versionFieldUC4_RadTimePicker1")))
        driver.execute_script("arguments[0].scrollIntoView(true);", time_input)
        wait.until(EC.element_to_be_clickable((By.ID,
            "ctl00_ContentPlaceHolder1_VersionFieldCollectionUsingUC1_versionFieldUC4_RadTimePicker1")))
        time_input.clear()
        time_input.send_keys(full_time_str)

        # === é»æ“Šé€å‡º ===
        submit_btn1 = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "#ctl00_MasterPageRadButton3 > .rbText")))
        driver.execute_script("arguments[0].scrollIntoView(true);", submit_btn1)
        submit_btn1.click()

        time.sleep(2)
        submit_btn2 = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "#ctl00_MasterPageRadButton2 > .rbText")))
        driver.execute_script("arguments[0].scrollIntoView(true);", submit_btn2)
        submit_btn2.click()

        msg = f"âœ… å·²æˆåŠŸæ‰“å¡ï¼ ({time_str})"
        logging.info(msg)
        return {"status": "success", "message": msg}

    except Exception as e:
        # === éŒ¯èª¤æ™‚è¼¸å‡º HTML èˆ‡æˆªåœ– ===
        ts = int(time.time())
        html_path = f"/app/error_{ts}.html"
        png_path = f"/app/error_{ts}.png"

        try:
            with open(html_path, "w", encoding="utf-8") as f:
                f.write(driver.page_source)
            driver.save_screenshot(png_path)
            logging.error(f"âŒ æ‰“å¡å¤±æ•—: {e}ï¼Œå·²è¼¸å‡º {html_path} èˆ‡ {png_path}")
        except Exception as log_err:
            logging.error(f"âŒ æ‰“å¡å¤±æ•—: {e}ï¼ˆç„¡æ³•è¼¸å‡ºHTMLï¼‰{log_err}")

        return {"status": "error", "message": str(e)}

    finally:
        driver.quit()

# === Flask è·¯ç”± ===
@app.route("/run-selenium", methods=["POST"])
def run_selenium():
    data = request.get_json()
    username = data.get("username")
    password = data.get("password")

    if not username or not password:
        return jsonify({"status": "error", "message": "ç¼ºå°‘ username æˆ– password"}), 400

    result = eip_checkin(username, password)
    return jsonify(result)

# === å•Ÿå‹• Flask ===
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8081)

